{% extends 'base.html' %}

{% block title %}{{ music.title }} | Mziktak{% endblock %}

{% block extra_css %}{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card mb-4">
                <div class="row g-0">
                    <div class="col-md-4">
                        <img src="{{ music.cover_image.url }}" class="img-fluid rounded-start h-100" alt="{{ music.title }}" style="object-fit: cover;">
                    </div>
                    <div class="col-md-8">
                        <div class="card-body">
                            <h2 class="card-title mb-1">{{ music.title }}</h2>
                            <p class="text-muted">by {{ music.artist.full_name }}</p>
                            
                            <div class="mb-3">
                                <span class="badge bg-primary">{{ music.get_genre_display }}</span>
                                <span class="badge bg-secondary">{{ music.duration }}</span>
                                <span class="badge bg-info">{{ music.release_date }}</span>
                            </div>

                            {% if user.is_authenticated %}
                            <!-- Rating System -->
                            <div class="mb-3">
                                <h6 class="mb-2">Rate this track:</h6>
                                <div class="rating">
                                    {% for i in '54321'|make_list %}
                                    <input type="radio" name="rating" value="{{ i }}" id="star{{ i }}" 
                                           {% if user_preference.rating == i|add:"0" %}checked{% endif %}>
                                    <label for="star{{ i }}">â˜…</label>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Favorite Button -->
                            <div class="mb-3">
                                <button class="btn {% if user_preference.favorite %}btn-danger{% else %}btn-outline-danger{% endif %} favorite-btn"
                                        data-music-id="{{ music.id }}">
                                    <i class="fas fa-heart"></i>
                                    <span>{% if user_preference.favorite %}Remove from{% else %}Add to{% endif %} Favorites</span>
                                </button>
                            </div>
                            {% endif %}

                            <div class="d-flex mt-3">
                                {% if user.is_authenticated %}
                                <a href="{% url 'music_statistics' music.id %}" class="btn btn-outline-primary me-2">
                                    <i class="fas fa-chart-bar me-2"></i>View Statistics
                                </a>
                                <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addToPlaylistModal">
                                    <i class="fas fa-plus me-1"></i> Add to Playlist
                                </button>
                                <a href="{{ music.audio_file.url }}" download class="btn btn-outline-primary me-2">
                                    <i class="fas fa-download me-1"></i> Download
                                </a>
                                {% endif %}
                                
                                {% if user.is_authenticated and user.is_artist and music.artist.user == user or user.is_admin %}
                                <div class="btn-group ms-auto">
                                    <a href="{% url 'edit_music' music.id %}" class="btn btn-outline-secondary">
                                        <i class="fas fa-edit"></i> Edit
                                    </a>
                                    <a href="{% url 'delete_music' music.id %}" class="btn btn-outline-danger">
                                        <i class="fas fa-trash"></i> Delete
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Audio Player -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">Listen to {{ music.title }}</h5>
                    <audio class="audio-player w-100" controls>
                        <source src="{{ music.audio_file.url }}" type="audio/mp3">
                        Your browser does not support the audio element.
                    </audio>
                </div>
            </div>
            
            {% if user_playlists %}
            <!-- Playlists containing this track -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Your playlists with this track</h5>
                    <ul class="list-group list-group-flush">
                        {% for playlist in user_playlists %}
                        <li class="list-group-item">
                            <a href="{% url 'playlist_detail' playlist.id %}" class="text-decoration-none">
                                {{ playlist.name }}
                            </a>
                            <span class="badge bg-secondary float-end">{{ playlist.music.count }} tracks</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% if user.is_authenticated %}
<!-- Add to Playlist Modal -->
<div class="modal fade" id="addToPlaylistModal" tabindex="-1" aria-labelledby="addToPlaylistModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addToPlaylistModalLabel">Add to Playlist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addToPlaylistForm" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="music_id" value="{{ music.id }}">
                    
                    <div class="mb-3">
                        <label class="form-label">Choose Playlist</label>
                        <select class="form-select" name="playlist_id" required>
                            <option value="">Select a playlist</option>
                            {% for playlist in user.playlist_set.all %}
                            <option value="{{ playlist.id }}">{{ playlist.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#createPlaylistModal">
                            Create New Playlist
                        </button>
                        <button type="submit" class="btn btn-primary">Add</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Create Playlist Modal -->
<div class="modal fade" id="createPlaylistModal" tabindex="-1" aria-labelledby="createPlaylistModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createPlaylistModalLabel">Create New Playlist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createPlaylistForm" action="{% url 'create_playlist' %}" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="initial_music" value="{{ music.id }}">
                    
                    <div class="mb-3">
                        <label for="playlistName" class="form-label">Playlist Name</label>
                        <input type="text" class="form-control" id="playlistName" name="name" required>
                    </div>
                    
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Playlist</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {

        // Rating System
        const ratingInputs = document.querySelectorAll('.rating input');
        ratingInputs.forEach(input => {
            input.addEventListener('change', function() {
                const rating = this.value;
                const musicId = '{{ music.id }}';
                
                fetch(`/music/${musicId}/rate/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: `rating=${rating}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showToast('Rating saved successfully!');
                    }
                });
            });
        });

        // Favorite Button
        const favoriteBtn = document.querySelector('.favorite-btn');
        if (favoriteBtn) {
            favoriteBtn.addEventListener('click', function() {
                const musicId = this.dataset.musicId;
                
                fetch(`/music/${musicId}/favorite/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Toggle button appearance
                        this.classList.toggle('btn-outline-danger');
                        this.classList.toggle('btn-danger');
                        
                        // Update text
                        const span = this.querySelector('span');
                        span.textContent = data.is_favorite ? 'Remove from Favorites' : 'Add to Favorites';
                        
                        showToast(data.is_favorite ? 'Added to favorites!' : 'Removed from favorites!');
                    }
                });
            });
        }

        // Toast notification function
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast show position-fixed bottom-0 end-0 m-3';
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="toast-header">
                    <strong class="me-auto">Notification</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">${message}</div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Initialize the audio player
        const player = new Plyr('.audio-player', {
            controls: [
                'play',
                'progress',
                'current-time',
                'mute',
                'volume',
                'download'
            ]
        });
        
        // Add to playlist functionality
        const addToPlaylistForm = document.getElementById('addToPlaylistForm');
        if (addToPlaylistForm) {
            addToPlaylistForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const playlistId = this.querySelector('select[name="playlist_id"]').value;
                if (!playlistId) {
                    alert('Please select a playlist.');
                    return;
                }
                
                // Submit form via AJAX
                const formData = new FormData(this);
                fetch('{% url "playlist_list" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Added to playlist successfully!');
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                });
            });
        }
    });
</script>
{% endblock %}